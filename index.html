<!DOCTYPE html>
<html lang="es">
<meta name="google-site-verification" content="SwTKNQDNIO_N9fwFybggtZvKPBQ3TeZ2ITvyaAUaDhs" />
    
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>koperi</title>
    <style>
        :root {
            --primary-color: #0052cc;
            --secondary-color: #f5f6f5;
            --accent-color: #ff4d4f;
            --text-color: #1a1a1a;
            --text-secondary: #595959;
            --border-color: #e8ecef;
            --white: #ffffff;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.15);
            --image-size: 80px;
            --media-height: 400px;
        }

        [data-theme="dark"] {
            --primary-color: #4d8cff;
            --secondary-color: #2d2d2d;
            --accent-color: #ff6b6b;
            --text-color: #ffffff;
            --text-secondary: #b0b0b0;
            --border-color: #444444;
            --white: #1a1a1a;
            --shadow: 0 2px 8px rgba(255, 255, 255, 0.1);
            --shadow-hover: 0 4px 12px rgba(255, 255, 255, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--secondary-color);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 32px;
        }

        header {
            background: var(--white);
            border-bottom: 1px solid var(--border-color);
            padding: 16px 24px;
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        header h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }

        header img {
            width: 32px;
            height: 32px;
            object-fit: contain;
        }

        #theme-toggle {
            margin-left: auto;
            padding: 8px 16px;
            background: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease, transform 0.3s ease;
        }

        #theme-toggle:hover {
            background: #003d99;
            transform: translateY(-2px);
        }

        #profile-section {
            background: var(--white);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow);
            position: sticky;
            top: 80px;
            text-align: center;
            transition: box-shadow 0.3s ease;
        }

        #profile-section:hover {
            box-shadow: var(--shadow-hover);
        }

        #profile-pic {
            width: var(--image-size);
            height: var(--image-size);
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-color);
            margin-bottom: 16px;
            transition: transform 0.3s ease;
        }

        #profile-pic:hover {
            transform: scale(1.05);
        }

        #profile-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            cursor: pointer;
            color: var(--text-color);
        }

        #profile-bio {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        #profile-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 16px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        #profile-stats div {
            font-weight: 500;
        }

        #profile-section button {
            width: 100%;
            margin: 8px 0;
        }

        #hamburger-menu {
            cursor: pointer;
            font-size: 24px;
            margin: 8px auto;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #dropdown-menu {
            display: none;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-top: 8px;
            box-shadow: var(--shadow);
        }

        #dropdown-menu button {
            display: block;
            width: 100%;
            padding: 10px;
            text-align: left;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 14px;
            cursor: pointer;
        }

        #dropdown-menu button:hover {
            background: var(--secondary-color);
        }

        #forum-section {
            background: var(--white);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow);
            transition: box-shadow 0.3s ease;
            position: relative;
        }

        #forum-section:hover {
            box-shadow: var(--shadow-hover);
        }

        #forum-section h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .search-container {
            position: relative;
            margin-bottom: 16px;
        }

        #search-bar {
            width: 100%;
            padding: 12px 12px 12px 40px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background: url('https://images.vexels.com/media/users/3/140723/isolated/preview/158241d2079a635fb0cae49accb56da5-icono-de-lupa.png') no-repeat 10px center;
            background-size: 20px;
        }

        #search-bar:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 8px rgba(0, 82, 204, 0.2);
            outline: none;
        }

        #sort-options, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 16px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        #sort-options:focus, textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 8px rgba(0, 82, 204, 0.2);
            outline: none;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .file-input-wrapper {
            position: relative;
            margin-bottom: 16px;
            display: flex;
            gap: 10px;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: var(--primary-color);
            color: var(--white);
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            transition: background 0.3s ease, transform 0.3s ease;
        }

        .file-input-label:hover {
            background: #003d99;
            transform: scale(1.1);
        }

        input[type="file"] {
            display: none;
        }

        button {
            padding: 10px 20px;
            background: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
        }

        button:hover {
            background: #003d99;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        button:active {
            transform: translateY(0);
        }

        .post {
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            transition: box-shadow 0.3s ease;
        }

        .post:hover {
            box-shadow: var(--shadow-hover);
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .post-header img {
            width: var(--image-size);
            height: var(--image-size);
            border-radius: 50%;
            object-fit: cover;
        }

        .post-header p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .post-header .username {
            font-weight: 600;
            color: var(--text-color);
            cursor: pointer;
        }

        .post-content p {
            font-size: 16px;
            margin-bottom: 16px;
        }

        .post-content img, .post-content video {
            width: 100%;
            height: var(--media-height);
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .post-content video {
            max-width: 100%;
            background: #000;
        }

        .post-actions {
            display: flex;
            gap: 16px;
            align-items: center;
            margin-bottom: 16px;
        }

        .post-actions button {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            font-size: 14px;
        }

        .post-actions button img {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }

        .post-actions button:hover {
            background: var(--secondary-color);
            color: var(--primary-color);
            transform: none;
        }

        .post-actions .like-btn.liked {
            color: var(--accent-color);
            border-color: var(--accent-color);
        }

        .post-actions .delete-btn {
            color: var(--accent-color);
            border-color: var(--accent-color);
        }

        .post-actions .delete-btn:hover {
            background: var(--accent-color);
            color: var(--white);
        }

        .reply {
            margin-left: 20px;
            padding: 12px;
            background: var(--secondary-color);
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .reply .post-header {
            margin-bottom: 8px;
        }

        .reply .post-header img {
            width: var(--image-size);
            height: var(--image-size);
            border-radius: 50%;
        }

        .reply p {
            font-size: 14px;
        }

        .reply img, .reply video {
            width: 100%;
            height: var(--media-height);
            border-radius: 8px;
            object-fit: contain;
        }

        .reply video {
            max-width: 100%;
            background: #000;
        }

        .error, .loading {
            color: var(--accent-color);
            font-size: 14px;
            margin: 12px 0;
        }

        .loading {
            color: var(--primary-color);
        }

        #modal, #login-modal, #profile-select-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--white);
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .modal-content img {
            width: var(--image-size);
            height: var(--image-size);
            border-radius: 50%;
            margin-bottom: 16px;
        }

        .modal-content input, .modal-content select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 16px;
        }

        .modal-content button {
            width: 100%;
            margin: 8px 0;
        }

        #notification {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--primary-color);
            color: var(--white);
            padding: 12px 24px;
            border-radius: 8px;
            display: none;
            box-shadow: var(--shadow);
        }

        #post-form {
            display: none;
            margin-bottom: 16px;
        }

        #toggle-post-form {
            position: absolute;
            top: 24px;
            right: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: var(--primary-color);
            color: var(--white);
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            font-weight: bold;
            transition: background 0.3s ease, transform 0.3s ease;
        }

        #toggle-post-form:hover {
            background: #003d99;
            transform: scale(1.1);
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                padding: 16px;
            }

            #profile-section {
                position: static;
            }

            .post {
                max-width: 100%;
            }

            #toggle-post-form, .file-input-wrapper {
                top: 16px;
                right: 16px;
            }

            button, #search-bar, #sort-options, textarea, input {
                font-size: 14px;
            }

            .file-input-wrapper {
                flex-direction: column;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <header>
        <img src="https://images.vexels.com/media/users/3/140723/isolated/preview/158241d2079a635fb0cae49accb56da5-icono-de-lupa.png" alt="Logo">
        <h1>koperi</h1>
        <button id="theme-toggle">Cambiar a Tema Oscuro</button>
    </header>
    <div id="login-modal">
        <div class="modal-content">
            <h2>Iniciar Sesión o Registrarse</h2>
            <input id="login-email" type="email" placeholder="Correo electrónico">
            <input id="login-password" type="password" placeholder="Contraseña">
            <button id="login-btn">Iniciar Sesión</button>
            <button id="register-btn">Registrarse</button>
            <p id="login-error" class="error"></p>
        </div>
    </div>
    <div id="profile-select-modal">
        <div class="modal-content">
            <h2>Seleccionar Perfil</h2>
            <select id="profile-select">
                <option value="">Selecciona un perfil</option>
            </select>
            <button id="select-profile-btn">Seleccionar Perfil</button>
            <button id="new-profile-btn">Crear Nuevo Perfil</button>
            <p id="profile-select-error" class="error"></p>
        </div>
    </div>
    <div id="modal">
        <div class="modal-content">
            <h2>Configura tu Perfil</h2>
            <img id="modal-profile-pic" src="https://via.placeholder.com/80" alt="Foto de Perfil">
            <input type="text" id="modal-display-name" placeholder="Ingresa tu nombre">
            <textarea id="modal-bio" placeholder="Escribe una breve biografía..."></textarea>
            <div class="file-input-wrapper">
                <label for="modal-profile-pic-input" class="file-input-label">📷</label>
                <input type="file" id="modal-profile-pic-input" accept="image/*" onchange="validateFile(this)">
            </div>
            <button id="modal-save-profile">Guardar Perfil</button>
            <p id="modal-error" class="error"></p>
        </div>
    </div>
    <div id="notification"></div>
    <div class="container">
        <div id="profile-section" style="display: none;">
            <img id="profile-pic" src="https://via.placeholder.com/80" alt="Foto de Perfil">
            <div id="profile-name"></div>
            <div id="profile-bio"></div>
            <div id="profile-stats">
                <div id="follower-count">Seguidores: 0</div>
                <div id="post-count">Publicaciones: 0</div>
            </div>
            <button id="edit-profile">Editar Perfil</button>
            <div id="hamburger-menu">☰</div>
            <div id="dropdown-menu">
                <button id="view-my-posts">Ver Mis Publicaciones</button>
                <button id="view-followers">Ver Seguidores</button>
                <button id="view-following">Ver Seguidos</button>
                <button id="go-back">Volver</button>
                <button id="go-back-alt">Regresar</button>
            </div>
            <button id="logout-btn">Cerrar Sesión</button>
        </div>
        <div id="forum-section">
            <div class="search-container">
                <input type="text" id="search-bar" placeholder="Buscar publicaciones...">
            </div>
            <select id="sort-options">
                <option value="timestamp-desc">Más Reciente</option>
                <option value="timestamp-asc">Más Antiguo</option>
                <option value="likes-desc">Más Likes</option>
            </select>
            <div id="toggle-post-form">+</div>
            <div id="post-form">
                <textarea id="post-content" placeholder="Escribe tu mensaje..."></textarea>
                <div class="file-input-wrapper">
                    <label for="post-image" class="file-input-label">📷</label>
                    <input type="file" id="post-image" accept="image/*" onchange="validateFile(this)">
                    <label for="post-video" class="file-input-label">🎥</label>
                    <input type="file" id="post-video" accept="video/mp4,video/webm,video/ogg" onchange="validateFile(this)">
                </div>
                <button id="submit-post">Publicar</button>
                <p id="error" class="error"></p>
                <p id="loading" class="loading"></p>
            </div>
            <h3>Publicaciones</h3>
            <div id="posts"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getDatabase, ref, set, onValue, get, remove, push, update, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAd1GyJ7xsCjw_BkuEyBbzyyzbXjPH-Pww",
            authDomain: "luner-a8aae.firebaseapp.com",
            databaseURL: "https://luner-a8aae-default-rtdb.firebaseio.com",
            projectId: "luner-a8aae",
            storageBucket: "luner-a8aae.appspot.com",
            messagingSenderId: "792035263055",
            appId: "1:792035263055:web:d9d2b1c69153b04c82203a",
            measurementId: "G-Y0NWKHWKG6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        getAnalytics(app);

        let clientId = localStorage.getItem('clientId');
        let profile = null;

        const loginModal = document.getElementById('login-modal');
        const loginEmail = document.getElementById('login-email');
        const loginPassword = document.getElementById('login-password');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const loginError = document.getElementById('login-error');
        const profileSelectModal = document.getElementById('profile-select-modal');
        const profileSelect = document.getElementById('profile-select');
        const selectProfileBtn = document.getElementById('select-profile-btn');
        const newProfileBtn = document.getElementById('new-profile-btn');
        const profileSelectError = document.getElementById('profile-select-error');
        const modal = document.getElementById('modal');
        const profileSection = document.getElementById('profile-section');
        const logoutBtn = document.getElementById('logout-btn');
        const hamburgerMenu = document.getElementById('hamburger-menu');
        const dropdownMenu = document.getElementById('dropdown-menu');

        document.addEventListener('DOMContentLoaded', () => {
            initializeThemeToggle();
            initializeHamburgerMenu();
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const email = user.email.replace(/\./g, '_');
                    const profilesSnapshot = await get(ref(database, `users/${email}`));
                    const profiles = profilesSnapshot.val() || {};
                    const profileKeys = Object.keys(profiles);
                    if (clientId && profiles[clientId]) {
                        profile = profiles[clientId];
                        localStorage.setItem('profile', JSON.stringify(profile));
                        profileSection.style.display = 'block';
                        loginModal.style.display = 'none';
                        profileSelectModal.style.display = 'none';
                        modal.style.display = 'none';
                        initializePostsListener();
                        initializeProfileListener();
                        initializePostFormToggle();
                        updateProfileUI();
                    } else if (profileKeys.length > 0) {
                        profileSelect.innerHTML = '<option value="">Selecciona un perfil</option>';
                        for (const key of profileKeys) {
                            const option = document.createElement('option');
                            option.value = key;
                            option.textContent = profiles[key].displayName || 'Perfil sin nombre';
                            profileSelect.appendChild(option);
                        }
                        loginModal.style.display = 'none';
                        profileSelectModal.style.display = 'flex';
                    } else {
                        loginModal.style.display = 'none';
                        profileSelectModal.style.display = 'none';
                        modal.style.display = 'flex';
                    }
                } else {
                    loginModal.style.display = 'flex';
                    profileSection.style.display = 'none';
                    profileSelectModal.style.display = 'none';
                    modal.style.display = 'none';
                }
            });
        });

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        window.validateFile = function(input) {
            const file = input.files[0];
            if (!file) return;
            const isVideo = input.accept.includes('video');
            const maxSizeMB = isVideo ? 50 : 10; // 50MB for videos, 10MB for images
            if (file.size > maxSizeMB * 1024 * 1024) {
                document.getElementById('error').textContent = `El archivo es demasiado grande. El tamaño máximo es ${maxSizeMB}MB.`;
                input.value = '';
                return;
            }
            const validImageTypes = ['image/jpeg', 'image/png', 'image/gif'];
            const validVideoTypes = ['video/mp4', 'video/webm', 'video/ogg'];
            if (input.id.includes('image') && !validImageTypes.includes(file.type)) {
                document.getElementById('error').textContent = 'Archivo inválido. Selecciona una imagen válida (JPEG, PNG, GIF).';
                input.value = '';
            } else if (input.id.includes('video') && !validVideoTypes.includes(file.type)) {
                document.getElementById('error').textContent = 'Archivo inválido. Selecciona un video válido (MP4, WebM, OGG).';
                input.value = '';
            }
        };

        async function compressMedia(file, isVideo = false) {
            if (!file) return null;
            const maxSizeMB = isVideo ? 50 : 10; // 50MB for videos, 10MB for images
            if (file.size > maxSizeMB * 1024 * 1024) {
                throw new Error(`El archivo es demasiado grande. El tamaño máximo es ${maxSizeMB}MB.`);
            }
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onerror = () => reject(new Error('Error al leer el archivo.'));
                reader.onload = (e) => {
                    if (!isVideo) {
                        const img = new Image();
                        img.onerror = () => reject(new Error('Error al cargar la imagen.'));
                        img.src = e.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            const maxWidth = 800;
                            const maxHeight = 800;
                            let width = img.width;
                            let height = img.height;

                            if (width > height) {
                                if (width > maxWidth) {
                                    height = Math.round((height * maxWidth) / width);
                                    width = maxWidth;
                                }
                            } else {
                                if (height > maxHeight) {
                                    width = Math.round((width * maxHeight) / height);
                                    height = maxHeight;
                                }
                            }

                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);
                            const base64 = canvas.toDataURL('image/jpeg', 0.7);
                            resolve(base64);
                        };
                    } else {
                        // For videos, return the base64 data without compression to maintain quality
                        resolve(e.target.result);
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        loginBtn.onclick = async () => {
            const email = loginEmail.value.trim();
            const password = loginPassword.value.trim();
            if (!email || !password) {
                loginError.textContent = 'Por favor, ingresa correo y contraseña.';
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, password);
                loginError.textContent = '';
            } catch (error) {
                let errorMessage = 'Error al iniciar sesión. Verifica tus credenciales.';
                if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Contraseña incorrecta.';
                } else if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Usuario no encontrado.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Demasiados intentos. Intenta de nuevo más tarde.';
                }
                loginError.textContent = errorMessage;
            }
        };

        registerBtn.onclick = async () => {
            const email = loginEmail.value.trim();
            const password = loginPassword.value.trim();
            if (!email || !password) {
                loginError.textContent = 'Por favor, ingresa correo y contraseña.';
                return;
            }
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                clientId = generateUUID();
                localStorage.setItem('clientId', clientId);
                loginError.textContent = '';
                modal.style.display = 'flex';
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') {
                    await signInWithEmailAndPassword(auth, email, password);
                    clientId = generateUUID();
                    localStorage.setItem('clientId', clientId);
                    loginError.textContent = '';
                    modal.style.display = 'flex';
                } else {
                    let errorMessage = 'Error al registrarse. Intenta de nuevo.';
                    if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Correo electrónico inválido.';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'La contraseña debe tener al menos 6 caracteres.';
                    }
                    loginError.textContent = errorMessage;
                }
            }
        };

        selectProfileBtn.onclick = async () => {
            const selectedClientId = profileSelect.value;
            if (!selectedClientId) {
                profileSelectError.textContent = 'Por favor, selecciona un perfil.';
                return;
            }
            clientId = selectedClientId;
            localStorage.setItem('clientId', clientId);
            const email = auth.currentUser.email.replace(/\./g, '_');
            const profileSnapshot = await get(ref(database, `users/${email}/${clientId}`));
            profile = profileSnapshot.val();
            localStorage.setItem('profile', JSON.stringify(profile));
            profileSection.style.display = 'block';
            profileSelectModal.style.display = 'none';
            initializePostsListener();
            initializeProfileListener();
            initializePostFormToggle();
            updateProfileUI();
        };

        newProfileBtn.onclick = () => {
            clientId = generateUUID();
            localStorage.setItem('clientId', clientId);
            profileSelectModal.style.display = 'none';
            modal.style.display = 'flex';
        };

        logoutBtn.onclick = async () => {
            try {
                await signOut(auth);
                localStorage.removeItem('clientId');
                localStorage.removeItem('profile');
                profileSection.style.display = 'none';
                loginModal.style.display = 'flex';
                showNotification('¡Sesión cerrada!');
            } catch (error) {
                document.getElementById('error').textContent = 'Error al cerrar sesión. Intenta de nuevo.';
            }
        };

        function initializeHamburgerMenu() {
            hamburgerMenu.addEventListener('click', () => {
                dropdownMenu.style.display = dropdownMenu.style.display === 'block' ? 'none' : 'block';
            });
        }

        function initializePostFormToggle() {
            const togglePostForm = document.getElementById('toggle-post-form');
            const postForm = document.getElementById('post-form');
            togglePostForm.addEventListener('click', () => {
                postForm.style.display = postForm.style.display === 'none' ? 'block' : 'none';
            });
        }

        function initializeThemeToggle() {
            const themeToggle = document.getElementById('theme-toggle');
            const currentTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            themeToggle.textContent = currentTheme === 'light' ? 'Cambiar a Tema Oscuro' : 'Cambiar a Tema Claro';
            
            themeToggle.addEventListener('click', () => {
                const newTheme = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                themeToggle.textContent = newTheme === 'light' ? 'Cambiar a Tema Oscuro' : 'Cambiar a Tema Claro';
            });
        }

        const modalDisplayName = document.getElementById('modal-display-name');
        const modalBio = document.getElementById('modal-bio');
        const modalProfilePicInput = document.getElementById('modal-profile-pic-input');
        const modalSaveProfile = document.getElementById('modal-save-profile');
        const modalError = document.getElementById('modal-error');
        const modalProfilePic = document.getElementById('modal-profile-pic');
        const profilePic = document.getElementById('profile-pic');
        const profileName = document.getElementById('profile-name');
        const profileBio = document.getElementById('profile-bio');
        const followerCount = document.getElementById('follower-count');
        const postCount = document.getElementById('post-count');
        const editProfileBtn = document.getElementById('edit-profile');
        const viewMyPostsBtn = document.getElementById('view-my-posts');
        const viewFollowersBtn = document.getElementById('view-followers');
        const viewFollowingBtn = document.getElementById('view-following');
        const goBackBtn = document.getElementById('go-back');
        const goBackAltBtn = document.getElementById('go-back-alt');
        const postsDiv = document.getElementById('posts');
        const postContent = document.getElementById('post-content');
        const postImage = document.getElementById('post-image');
        const postVideo = document.getElementById('post-video');
        const submitPost = document.getElementById('submit-post');
        const errorDiv = document.getElementById('error');
        const loadingDiv = document.getElementById('loading');
        const searchBar = document.getElementById('search-bar');
        const sortOptions = document.getElementById('sort-options');
        const notification = document.getElementById('notification');

        function updateProfileUI() {
            if (profile) {
                profilePic.src = profile.profilePic;
                profileName.textContent = profile.displayName;
                profileBio.textContent = profile.bio || '';
                profileName.addEventListener('click', () => viewUserProfile(clientId));
            }
        }

        function renderPosts(postsToRender, showReplies = true) {
            postsDiv.innerHTML = '';
            if (!postsToRender || postsToRender.length === 0) {
                postsDiv.innerHTML = '<p>No hay publicaciones disponibles.</p>';
                return;
            }
            postsToRender.forEach(post => {
                if (!post || !post.id || !post.content || typeof post.content !== 'string') {
                    console.warn('Publicación inválida ignorada:', post);
                    return;
                }
                const postElement = document.createElement('div');
                postElement.className = 'post';
                const mediaContent = post.image ? `<img src="${post.image}" alt="Imagen de Publicación" onerror="this.style.display='none';">` :
                                  post.video ? `<video controls src="${post.video}" onerror="this.style.display='none';"></video>` : '';
                postElement.innerHTML = `
                    <div class="post-header">
                        <img src="${post.profilePic || 'https://via.placeholder.com/80'}" alt="Usuario" onerror="this.src='https://via.placeholder.com/80';">
                        <p><strong class="username" data-client-id="${post.clientId}">${post.user || 'Anónimo'}</strong> (${new Date(post.timestamp || Date.now()).toLocaleString()}):</p>
                    </div>
                    <div class="post-content">
                        <p>${post.content}</p>
                        ${mediaContent}
                    </div>
                    <div class="post-actions">
                        <button class="like-btn ${post.likes?.includes(clientId) ? 'liked' : ''}">
                            <img src="https://static.vecteezy.com/system/resources/previews/009/875/160/original/3d-love-heart-red-color-and-speech-bubble-free-png.png" alt="Like">
                            (${post.likes ? post.likes.length : 0})
                        </button>
                        ${post.clientId === clientId ? `
                            <button class="edit-btn">Editar</button>
                            <button class="delete-btn">Eliminar</button>
                        ` : ''}
                        <button class="reply-btn">
                            <img src="https://static.vecteezy.com/system/resources/previews/012/627/893/non_2x/3d-message-bubble-free-png.png" alt="Comentar">
                            Comentar
                        </button>
                        <button class="toggle-replies-btn">${showReplies ? 'Ocultar Respuestas' : 'Mostrar Respuestas'}</button>
                        ${post.clientId !== clientId ? `
                            <button class="follow-btn ${post.followers?.includes(clientId) ? 'followed' : ''}">
                                ${post.followers?.includes(clientId) ? 'Dejar de Seguir' : 'Seguir'}
                            </button>
                        ` : ''}
                    </div>
                    <div id="edit-form-${post.id}" style="display: none;">
                        <textarea id="edit-content-${post.id}">${post.content}</textarea>
                        <div class="file-input-wrapper">
                            <label for="edit-image-${post.id}" class="file-input-label">📷</label>
                            <input type="file" id="edit-image-${post.id}" accept="image/*" onchange="validateFile(this)">
                            <label for="edit-video-${post.id}" class="file-input-label">🎥</label>
                            <input type="file" id="edit-video-${post.id}" accept="video/mp4,video/webm,video/ogg" onchange="validateFile(this)">
                        </div>
                        <button class="edit-submit-btn">Guardar Cambios</button>
                    </div>
                    <div id="reply-form-${post.id}" style="display: none;">
                        <textarea id="reply-content-${post.id}" placeholder="Escribe tu respuesta..."></textarea>
                        <div class="file-input-wrapper">
                            <label for="reply-image-${post.id}" class="file-input-label">📷</label>
                            <input type="file" id="reply-image-${post.id}" accept="image/*" onchange="validateFile(this)">
                            <label for="reply-video-${post.id}" class="file-input-label">🎥</label>
                            <input type="file" id="reply-video-${post.id}" accept="video/mp4,video/webm,video/ogg" onchange="validateFile(this)">
                        </div>
                        <button class="reply-submit-btn">Enviar Respuesta</button>
                    </div>
                    <div class="replies" style="display: ${showReplies ? 'block' : 'none'};">
                        ${post.replies ? Object.entries(post.replies).map(([replyId, reply]) => `
                            <div class="reply">
                                <div class="post-header">
                                    <img src="${reply.profilePic || 'https://via.placeholder.com/80'}" alt="Usuario" onerror="this.src='https://via.placeholder.com/80';">
                                    <p><strong class="username" data-client-id="${reply.clientId}">${reply.user || 'Anónimo'}</strong> (${new Date(reply.timestamp || Date.now()).toLocaleString()}):</p>
                                    ${reply.clientId === clientId ? `<button class="delete-reply-btn" data-reply-id="${replyId}">Eliminar</button>` : ''}
                                </div>
                                <p>${reply.content || ''}</p>
                                ${reply.image ? `<img src="${reply.image}" alt="Imagen de Respuesta" onerror="this.style.display='none';">` : 
                                  reply.video ? `<video controls src="${reply.video}" onerror="this.style.display='none';"></video>` : ''}
                            </div>
                        `).join('') : ''}
                    </div>
                `;
                postsDiv.appendChild(postElement);

                postElement.querySelector('.like-btn')?.addEventListener('click', () => toggleLike(post.id));
                postElement.querySelector('.edit-btn')?.addEventListener('click', () => editPost(post.id));
                postElement.querySelector('.delete-btn')?.addEventListener('click', () => deletePost(post.id));
                postElement.querySelector('.reply-btn')?.addEventListener('click', () => showReplyForm(post.id));
                postElement.querySelector('.edit-submit-btn')?.addEventListener('click', () => submitEdit(post.id));
                postElement.querySelector('.reply-submit-btn')?.addEventListener('click', () => submitReply(post.id));
                postElement.querySelector('.toggle-replies-btn')?.addEventListener('click', () => toggleReplies(post.id));
                postElement.querySelector('.follow-btn')?.addEventListener('click', () => toggleFollow(post.clientId));
                postElement.querySelector('.username')?.addEventListener('click', () => viewUserProfile(post.clientId));
                postElement.querySelectorAll('.delete-reply-btn')?.forEach(btn => {
                    btn.addEventListener('click', () => deleteReply(post.id, btn.dataset.replyId));
                });
            });
        }

        function filterAndSortPosts(posts) {
            let filteredPosts = [...posts];
            const searchTerm = searchBar.value.toLowerCase();
            if (searchTerm) {
                filteredPosts = filteredPosts.filter(post =>
                    (post.content || '').toLowerCase().includes(searchTerm) ||
                    (post.user || '').toLowerCase().includes(searchTerm)
                );
            }
            const sortOption = sortOptions.value;
            if (sortOption === 'timestamp-asc') {
                filteredPosts.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
            } else if (sortOption === 'timestamp-desc') {
                filteredPosts.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            } else if (sortOption === 'likes-desc') {
                filteredPosts.sort((a, b) => (b.likes?.length || 0) - (a.likes?.length || 0));
            }
            return filteredPosts;
        }

        function initializePostsListener(retryCount = 0, maxRetries = 3) {
            if (!database) {
                document.getElementById('error').textContent = 'Error de conexión. Verifica tu conexión a internet.';
                return;
            }
            const postsQuery = query(ref(database, 'posts'), orderByChild('timestamp'), limitToLast(20));
            onValue(postsQuery, (snapshot) => {
                try {
                    if (!snapshot.exists()) {
                        renderPosts([]);
                        return;
                    }
                    const posts = [];
                    snapshot.forEach(child => {
                        const postData = child.val();
                        if (postData && postData.id && postData.content) {
                            posts.push(postData);
                        }
                    });
                    renderPosts(filterAndSortPosts(posts));
                    showNotification('¡Publicaciones actualizadas!');
                } catch (error) {
                    console.error('Error al procesar publicaciones:', error);
                    document.getElementById('error').textContent = 'Error al cargar publicaciones. Intenta de nuevo.';
                }
            }, (error) => {
                let errorMessage = 'Error al conectar con la base de datos.';
                if (error.code === 'PERMISSION_DENIED') {
                    errorMessage = 'Permisos insuficientes para leer los datos.';
                } else if (error.code === 'NETWORK_ERROR') {
                    errorMessage = 'Error de red. Verifica tu conexión a internet.';
                }
                document.getElementById('error').textContent = errorMessage;
                if (retryCount < maxRetries) {
                    setTimeout(() => initializePostsListener(retryCount + 1, maxRetries), 5000);
                } else {
                    document.getElementById('error').textContent = 'Error persistente. Recarga la página.';
                }
            });
        }

        function initializeProfileListener() {
            if (!database || !clientId) return;
            const userRef = ref(database, `users/${auth.currentUser.email.replace(/\./g, '_')}/${clientId}`);
            onValue(userRef, (snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    profile = userData;
                    localStorage.setItem('profile', JSON.stringify(profile));
                    followerCount.textContent = `Seguidores: ${userData.followers ? userData.followers.length : 0}`;
                    postCount.textContent = `Publicaciones: ${userData.postCount || 0}`;
                    updateProfileUI();
                }
            });
        }

        function showNotification(message) {
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        async function saveProfile(name, bio, file) {
            if (!name) {
                modalError.textContent = 'Por favor, ingresa un nombre.';
                return;
            }
            if (!auth.currentUser) {
                modalError.textContent = 'Debes estar autenticado para guardar el perfil.';
                return;
            }
            try {
                let profilePicUrl = profile?.profilePic || 'https://via.placeholder.com/80';
                if (file) {
                    profilePicUrl = await compressMedia(file);
                }
                profile = {
                    displayName: name,
                    profilePic: profilePicUrl,
                    bio: bio || '',
                    email: auth.currentUser.email,
                    followers: profile?.followers || [],
                    following: profile?.following || [],
                    postCount: profile?.postCount || 0
                };
                localStorage.setItem('profile', JSON.stringify(profile));
                await set(ref(database, `users/${auth.currentUser.email.replace(/\./g, '_')}/${clientId}`), profile);
                profilePic.src = profile.profilePic;
                profileName.textContent = profile.displayName;
                profileBio.textContent = profile.bio;
                profileName.addEventListener('click', () => viewUserProfile(clientId));
                modal.style.display = 'none';
                profileSection.style.display = 'block';
                errorDiv.textContent = '';
                modalError.textContent = '';
                showNotification('¡Perfil guardado!');
                initializePostsListener();
                initializeProfileListener();
                initializePostFormToggle();
            } catch (error) {
                console.error('Error al guardar el perfil:', error);
                modalError.textContent = 'Error al guardar el perfil. Intenta de nuevo.';
            }
        }

        modalSaveProfile.onclick = () => {
            const name = modalDisplayName.value.trim();
            const bio = modalBio.value.trim();
            const file = modalProfilePicInput.files[0];
            saveProfile(name, bio, file);
        };

        editProfileBtn.onclick = () => {
            modal.style.display = 'flex';
            modalDisplayName.value = profile.displayName || '';
            modalBio.value = profile.bio || '';
            modalProfilePic.src = profile.profilePic || 'https://via.placeholder.com/80';
        };

        async function viewUserProfile(userId) {
            if (!database) {
                errorDiv.textContent = 'Error de conexión. Verifica tu conexión a internet.';
                return;
            }
            try {
                const userSnapshot = await get(ref(database, `users/${auth.currentUser.email.replace(/\./g, '_')}/${userId}`));
                const user = userSnapshot.val();
                if (!user) {
                    errorDiv.textContent = 'Usuario no encontrado.';
                    return;
                }
                postsDiv.innerHTML = `
                    <div class="post">
                        <div style="text-align: center;">
                            <img src="${user.profilePic || 'https://via.placeholder.com/80'}" alt="Foto de Perfil" style="width: var(--image-size); height: var(--image-size); border-radius: 50%; margin-bottom: 16px;">
                            <h2>${user.displayName || 'Anónimo'}</h2>
                            <p>${user.bio || ''}</p>
                            <div style="display: flex; justify-content: center; gap: 20px; margin: 16px 0;">
                                <div>Seguidores: ${user.followers ? user.followers.length : 0}</div>
                                <div>Publicaciones: ${user.postCount || 0}</div>
                            </div>
                            ${userId === clientId ? `
                                <button onclick="document.getElementById('edit-profile').click()">Editar Perfil</button>
                                <button onclick="document.getElementById('view-my-posts').click()">Ver Mis Publicaciones</button>
                                <button onclick="document.getElementById('view-followers').click()">Ver Seguidores</button>
                                <button onclick="document.getElementById('view-following').click()">Ver Seguidos</button>
                            ` : `
                                <button class="follow-btn ${user.followers?.includes(clientId) ? 'followed' : ''}" onclick="toggleFollow('${userId}')">
                                    ${user.followers?.includes(clientId) ? 'Dejar de Seguir' : 'Seguir'}
                                </button>
                            `}
                        </div>
                    </div>
                `;
                dropdownMenu.style.display = 'none';
            } catch (error) {
                console.error('Error al cargar perfil:', error);
                errorDiv.textContent = 'Error al cargar perfil. Intenta de nuevo.';
            }
        }

        viewMyPostsBtn.onclick = () => {
            viewUserPosts(clientId);
            dropdownMenu.style.display = 'none';
        };

        viewFollowersBtn.onclick = async () => {
            if (!database) {
                errorDiv.textContent = 'Error de conexión. Verifica tu conexión a internet.';
                return;
            }
            try {
                const userRef = ref(database, `users/${auth.currentUser.email.replace(/\./g, '_')}/${clientId}/followers`);
                const snapshot = await get(userRef);
                const followers = snapshot.val() || [];
                postsDiv.innerHTML = '<h3>Seguidores</h3>';
                if (followers.length === 0) {
                    postsDiv.innerHTML += '<p>No tienes seguidores.</p>';
                    return;
                }
                const userPromises = followers.map(async (followerId) => {
                    const userSnapshot = await get(ref(database, `users/${auth.currentUser.email.replace(/\./g, '_')}/${followerId}`));
                    return { ...userSnapshot.val(), clientId: followerId };
                });
                const users = await Promise.all(userPromises);
                users.forEach(user => {
                    if (user) {
                        const userElement = document.createElement('div');
                        userElement.className = 'post';
                        userElement.innerHTML = `
                            <div class="post-header">
                                <img src="${user.profilePic || 'https://via.placeholder.com/80'}" alt="Usuario">
                                <p><strong class="username" data-client-id="${user.clientId}">${user.displayName}</strong></p>
                            </div>
                        `;
                        userElement.querySelector('.username').addEventListener('click', () => viewUserProfile(user.clientId));
                        postsDiv.appendChild(userElement);
                    }
                });
                dropdownMenu.style.display = 'none';
            } catch (error) {
                console.error('Error al cargar seguidores:', error);
                errorDiv.textContent = 'Error al cargar seguidores. Intenta de nuevo.';
            }
        };

        viewFollowingBtn.onclick = async () => {
            if (!database) {
                errorDiv.textContent = 'Error de conexión. Verifica tu conexión a internet.';
                return;
            }
            try {
                const followingRef = ref(database, `users/${auth.currentUser.email.replace(/\./g, '_')}/${clientId}/following`);
                const snapshot = await get(followingRef);
                const following = snapshot.val() || [];
                postsDiv.innerHTML = '<h3>Seguidos</h3>';
                if (following.length === 0) {
                    postsDiv.innerHTML += '<p>No sigues a nadie.</p>';
                    return;
                }
                const userPromises = following.map(async (followedId) => {
                    const userSnapshot = await get(ref(database, `users/${auth.currentUser.email.replace(/\./g, '_')}/${followedId}`));
                    return { ...userSnapshot.val(), clientId: followedId };
                });
                const users = await Promise.all(userPromises);
                users.forEach(user => {
                    if (user) {
                        const userElement = document.createElement('div');
                        userElement.className = 'post';
                        userElement.innerHTML = `
                            <div class="post-header">
                                <img src="${user.profilePic || 'https://via.placeholder.com/80'}" alt="Usuario">
                                <p><strong class="username" data-client-id="${user.clientId}">${user.displayName}</strong></p>
                            </div>
                        `;
                        userElement.querySelector('.username').addEventListener('click', () => viewUserProfile(user.clientId));
                        postsDiv.appendChild(userElement);
                    }
                });
                dropdownMenu.style.display = 'none';
            } catch (error) {
                console.error('Error al cargar seguidos:', error);
                errorDiv.textContent = 'Error al cargar seguidos. Intenta de nuevo.';
            }
        };

        goBackBtn.onclick = goBackAltBtn.onclick = () => {
            initializePostsListener();
            dropdownMenu.style.display = 'none';
        };

        async function viewUserPosts(userId) {
            if (!database) {
                errorDiv.textContent = 'Error de conexión. Verifica tu conexión a internet.';
                return;
            }
            try {
                const postsSnapshot = await get(ref(database, 'posts'));
                const userSnapshot = await get(ref(database, `users/${auth.currentUser.email.replace(/\./g, '_')}/${userId}`));
                const user = userSnapshot.val();
                const posts = [];
                postsSnapshot.forEach(child => {
                    const postData = child.val();
                    if (postData && postData.id && postData.content && postData.clientId === userId) {
                        posts.push(postData);
                    }
                });
                postsDiv.innerHTML = `<h3>Publicaciones de ${user?.displayName || 'Usuario'}</h3>`;
                renderPosts(filterAndSortPosts(posts));
            } catch (error) {
                console.error('Error al cargar publicaciones del usuario:', error);
                errorDiv.textContent = 'Error al cargar publicaciones. Intenta de nuevo.';
            }
        }

        async function submitPostWithRetry(content, imageFile, videoFile, retries = 3, delay = 5000) {
            if (!database || !auth.currentUser) {
                errorDiv.textContent = 'Error de conexión o usuario no autenticado.';
                return false;
            }
            try {
                let imageUrl = null;
                let videoUrl = null;
                if (imageFile) {
                    imageUrl = await compressMedia(imageFile);
                } else if (videoFile) {
                    videoUrl = await compressMedia(videoFile, true);
                }
                const newPost = {
                    id: generateUUID(),
                    content: content,
                    user: profile.displayName,
                    profilePic: profile.profilePic,
                    clientId: clientId,
                    timestamp: Date.now(),
                    image: imageUrl,
                    video: videoUrl,
                    replies: {},
                    likes: [],
                    followers: [],
                    email: auth.currentUser.email
                };
                await set(ref(database, 'posts/' + newPost.id), newPost);
                const userRef = ref(database, `users/${auth.currentUser.email.replace(/\./g, '_')}/${clientId}`);
                const userSnapshot = await get(userRef);
                const userData = userSnapshot.val() || { postCount: 0 };
                await update(userRef, { postCount: (userData.postCount || 0) + 1 });
                document.getElementById('post-form').style.display = 'none';
                return true;
            } catch (error) {
                if (retries > 0 && error.message.includes('Tiempo de espera agotado')) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return submitPostWithRetry(content, imageFile, videoFile, retries - 1, delay);
                }
                throw error;
            }
        }

        submitPost.onclick = async () => {
            if (!profile || !auth.currentUser) {
                errorDiv.textContent = 'Por favor, configura tu perfil y asegúrate de estar autenticado.';
                return;
            }
            const content = postContent.value.trim();
            if (!content) {
                errorDiv.textContent = 'Por favor, ingresa un mensaje.';
                return;
            }
            loadingDiv.textContent = 'Publicando...';
            submitPost.disabled = true;
            try {
                const imageFile = postImage.files[0];
                const videoFile = postVideo.files[0];
                if (imageFile && videoFile) {
                    throw new Error('Por favor, selecciona solo una imagen o un video.');
                }
                if (imageFile && !['image/jpeg', 'image/png', 'image/gif'].includes(imageFile.type)) {
                    throw new Error('Archivo inválido. Selecciona una imagen válida (JPEG, PNG, GIF).');
                }
                if (videoFile && !['video/mp4', 'video/webm', 'video/ogg'].includes(videoFile.type)) {
                    throw new Error('Archivo inválido. Selecciona un video válido (MP4, WebM, OGG).');
                }
                const success = await submitPostWithRetry(content, imageFile, videoFile);
                if (success) {
                    postContent.value = '';
                    postImage.value = '';
                    postVideo.value = '';
                    errorDiv.textContent = '';
                    loadingDiv.textContent = '';
                    showNotification('¡Publicación creada!');
                }
            } catch (error) {
                console.error('Error al publicar:', error);
                errorDiv.textContent = 'Error al publicar. Intenta de nuevo.';
                loadingDiv.textContent = '';
            } finally {
                submitPost.disabled = false;
            }
        };

        window.deletePost = async (postId) => {
            if (!database || !auth.currentUser) {
                errorDiv.textContent = 'Error de conexión o usuario no autenticado.';
                return;
            }
            loadingDiv.textContent = 'Eliminando...';
            try {
                const postRef = ref(database, 'posts/' + postId);
                const snapshot = await get(postRef);
                if (snapshot.val()?.clientId === clientId) {
                    await remove(postRef);
                    const userRef = ref(database, `users/${auth.currentUser.email.replace(/\./g, '_')}/${clientId}`);
                    const userSnapshot = await get(userRef);
                    const userData = userSnapshot.val() || { postCount: 0 };
                    await update(userRef, { postCount: Math.max(0, (userData.postCount || 0) - 1) });
                    loadingDiv.textContent = '';
                    showNotification('¡Publicación eliminada!');
                } else {
                    errorDiv.textContent = 'No tienes permiso para eliminar esta publicación.';
                    loadingDiv.textContent = '';
                }
            } catch (error) {
                console.error('Error al eliminar publicación:', error);
                errorDiv.textContent = 'Error al eliminar publicación. Intenta de nuevo.';
                loadingDiv.textContent = '';
            }
        };

        window.deleteReply = async (postId, replyId) => {
            if (!database || !auth.currentUser) {
                errorDiv.textContent = 'Error de conexión o usuario no autenticado.';
                return;
            }
            loadingDiv.textContent = 'Eliminando respuesta...';
            try {
                const replyRef = ref(database, `posts/${postId}/replies/${replyId}`);
                const snapshot = await get(replyRef);
                if (snapshot.val()?.clientId === clientId) {
                    await remove(replyRef);
                    loadingDiv.textContent = '';
                    showNotification('¡Respuesta eliminada!');
                } else {
                    errorDiv.textContent = 'No tienes permiso para eliminar esta respuesta.';
                    loadingDiv.textContent = '';
                }
            } catch (error) {
                console.error('Error al eliminar respuesta:', error);
                errorDiv.textContent = 'Error al eliminar respuesta. Intenta de nuevo.';
                loadingDiv.textContent = '';
            }
        };

        window.editPost = (postId) => {
            if (!database || !auth.currentUser) {
                errorDiv.textContent = 'Error de conexión o usuario no autenticado.';
                return;
            }
            get(ref(database, 'posts/' + postId)).then((snapshot) => {
                if (snapshot.val()?.clientId === clientId) {
                    const editForm = document.getElementById(`edit-form-${postId}`);
                    if (editForm) {
                        editForm.style.display = 'block';
                    }
                } else {
                    errorDiv.textContent = 'No tienes permiso para editar esta publicación.';
                }
            }).catch((error) => {
                console.error('Error al verificar publicación:', error);
                errorDiv.textContent = 'Error al verificar publicación. Intenta de nuevo.';
            });
        };

        window.submitEdit = async (postId) => {
            const content = document.getElementById(`edit-content-${postId}`).value.trim();
            if (!content) {
                errorDiv.textContent = 'Por favor, ingresa un mensaje.';
                return;
            }
            if (!database || !auth.currentUser) {
                errorDiv.textContent = 'Error de conexión o usuario no autenticado.';
                return;
            }
            loadingDiv.textContent = 'Guardando...';
            try {
                const imageFile = document.getElementById(`edit-image-${postId}`).files[0];
                const videoFile = document.getElementById(`edit-video-${postId}`).files[0];
                if (imageFile && videoFile) {
                    throw new Error('Por favor, selecciona solo una imagen o un video.');
                }
                if (imageFile && !['image/jpeg', 'image/png', 'image/gif'].includes(imageFile.type)) {
                    throw new Error('Archivo inválido. Selecciona una imagen válida (JPEG, PNG, GIF).');
                }
                if (videoFile && !['video/mp4', 'video/webm', 'video/ogg'].includes(videoFile.type)) {
                    throw new Error('Archivo inválido. Selecciona un video válido (MP4, WebM, OGG).');
                }
                const postRef = ref(database, 'posts/' + postId);
                const snapshot = await get(postRef);
                const post = snapshot.val();
                if (post && post.clientId === clientId) {
                    let imageUrl = post.image;
                    let videoUrl = post.video;
                    if (imageFile) {
                        imageUrl = await compressMedia(imageFile);
                        videoUrl = null;
                    } else if (videoFile) {
                        videoUrl = await compressMedia(videoFile, true);
                        imageUrl = null;
                    }
                    await update(postRef, { content, image: imageUrl, video: videoUrl });
                    document.getElementById(`edit-form-${postId}`).style.display = 'none';
                    errorDiv.textContent = '';
                    loadingDiv.textContent = '';
                    showNotification('¡Publicación actualizada!');
                } else {
                    errorDiv.textContent = 'No tienes permiso para editar esta publicación.';
                    loadingDiv.textContent = '';
                }
            } catch (error) {
                console.error('Error al actualizar publicación:', error);
                errorDiv.textContent = 'Error al actualizar publicación. Intenta de nuevo.';
                loadingDiv.textContent = '';
            }
        };

        window.toggleLike = async (postId) => {
            if (!database || !auth.currentUser) {
                errorDiv.textContent = 'Error de conexión o usuario no autenticado.';
                return;
            }
            try {
                const postRef = ref(database, 'posts/' + postId + '/likes');
                const snapshot = await get(postRef);
                let likes = snapshot.val() || [];
                if (likes.includes(clientId)) {
                    likes = likes.filter(id => id !== clientId);
                } else {
                    likes.push(clientId);
                }
                await set(postRef, likes);
                showNotification('¡Like actualizado!');
            } catch (error) {
                console.error('Error al actualizar like:', error);
                errorDiv.textContent = 'Error al actualizar like. Intenta de nuevo.';
            }
        };

        window.toggleFollow = async (userId) => {
            if (!database || !auth.currentUser) {
                errorDiv.textContent = 'Error de conexión o usuario no autenticado.';
                return;
            }
            try {
                const userRef = ref(database, `users/${auth.currentUser.email.replace(/\./g, '_')}/${userId}`);
                const currentUserRef = ref(database, `users/${auth.currentUser.email.replace(/\./g, '_')}/${clientId}`);
                const userSnapshot = await get(userRef);
                const currentUserSnapshot = await get(currentUserRef);
                let userData = userSnapshot.val() || { followers: [] };
                let currentUserData = currentUserSnapshot.val() || { following: [] };
                let followers = userData.followers || [];
                let following = currentUserData.following || [];
                
                if (followers.includes(clientId)) {
                    followers = followers.filter(id => id !== clientId);
                    following = following.filter(id => id !== userId);
                } else {
                    followers.push(clientId);
                    following.push(userId);
                }
                
                await update(userRef, { followers });
                await update(currentUserRef, { following });
                showNotification(followers.includes(clientId) ? '¡Ahora sigues a este usuario!' : '¡Has dejado de seguir a este usuario!');
                
                const updatedUserSnapshot = await get(ref(database, `users/${auth.currentUser.email.replace(/\./g, '_')}/${clientId}`));
                const updatedUser = updatedUserSnapshot.val();
                if (updatedUser) {
                    followerCount.textContent = `Seguidores: ${updatedUser.followers ? updatedUser.followers.length : 0}`;
                    postCount.textContent = `Publicaciones: ${updatedUser.postCount || 0}`;
                }
            } catch (error) {
                console.error('Error al actualizar seguimiento:', error);
                errorDiv.textContent = 'Error al actualizar seguimiento. Intenta de nuevo.';
            }
        };

        window.showReplyForm = (postId) => {
            const replyForm = document.getElementById(`reply-form-${postId}`);
            if (replyForm) {
                replyForm.style.display = 'block';
            }
        };

        window.toggleReplies = (postId) => {
            const repliesDiv = document.getElementById(`reply-form-${postId}`).nextElementSibling;
            const toggleBtn = repliesDiv.parentElement.querySelector('.toggle-replies-btn');
            if (repliesDiv.style.display === 'none') {
                repliesDiv.style.display = 'block';
                toggleBtn.textContent = 'Ocultar Respuestas';
            } else {
                repliesDiv.style.display = 'none';
                toggleBtn.textContent = 'Mostrar Respuestas';
            }
        };

        window.submitReply = async (postId) => {
            if (!profile || !auth.currentUser) {
                errorDiv.textContent = 'Por favor, configura tu perfil y asegúrate de estar autenticado.';
                return;
            }
            const replyContent = document.getElementById(`reply-content-${postId}`).value.trim();
            if (!replyContent) {
                errorDiv.textContent = 'Por favor, ingresa una respuesta.';
                return;
            }
            if (!database) {
                errorDiv.textContent = 'Error de conexión.';
                return;
            }
            loadingDiv.textContent = 'Publicando respuesta...';
            try {
                const imageFile = document.getElementById(`reply-image-${postId}`).files[0];
                const videoFile = document.getElementById(`reply-video-${postId}`).files[0];
                if (imageFile && videoFile) {
                    throw new Error('Por favor, selecciona solo una imagen o un video.');
                }
                if (imageFile && !['image/jpeg', 'image/png', 'image/gif'].includes(imageFile.type)) {
                    throw new Error('Archivo inválido. Selecciona una imagen válida (JPEG, PNG, GIF).');
                }
                if (videoFile && !['video/mp4', 'video/webm', 'video/ogg'].includes(videoFile.type)) {
                    throw new Error('Archivo inválido. Selecciona un video válido (MP4, WebM, OGG).');
                }
                let imageUrl = null;
                let videoUrl = null;
                if (imageFile) {
                    imageUrl = await compressMedia(imageFile);
                } else if (videoFile) {
                    videoUrl = await compressMedia(videoFile, true);
                }
                const reply = {
                    content: replyContent,
                    user: profile.displayName,
                    profilePic: profile.profilePic,
                    clientId: clientId,
                    timestamp: Date.now(),
                    image: imageUrl,
                    video: videoUrl,
                    email: auth.currentUser.email
                };
                const replyRef = await push(ref(database, `posts/${postId}/replies`), reply);
                document.getElementById(`reply-form-${postId}`).style.display = 'none';
                document.getElementById(`reply-content-${postId}`).value = '';
                document.getElementById(`reply-image-${postId}`).value = '';
                document.getElementById(`reply-video-${postId}`).value = '';
                errorDiv.textContent = '';
                loadingDiv.textContent = '';
                showNotification('¡Respuesta publicada!');
            } catch (error) {
                console.error('Error al publicar respuesta:', error);
                errorDiv.textContent = 'Error al publicar respuesta. Intenta de nuevo.';
                loadingDiv.textContent = '';
            }
        };

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        searchBar.addEventListener('input', debounce(() => {
            if (!database) {
                errorDiv.textContent = 'Error de conexión.';
                return;
            }
            get(ref(database, 'posts')).then((snapshot) => {
                try {
                    const posts = [];
                    snapshot.forEach(child => {
                        const postData = child.val();
                        if (postData && postData.id && postData.content) {
                            posts.push(postData);
                        }
                    });
                    renderPosts(filterAndSortPosts(posts));
                } catch (error) {
                    console.error('Error al buscar publicaciones:', error);
                    errorDiv.textContent = 'Error al buscar publicaciones. Intenta de nuevo.';
                }
            }).catch((error) => {
                console.error('Error al obtener publicaciones para búsqueda:', error);
                errorDiv.textContent = 'Error al cargar publicaciones. Intenta de nuevo.';
            });
        }, 500));

        sortOptions.addEventListener('change', () => {
            if (!database) {
                errorDiv.textContent = 'Error de conexión.';
                return;
            }
            get(ref(database, 'posts')).then((snapshot) => {
                try {
                    const posts = [];
                    snapshot.forEach(child => {
                        const postData = child.val();
                        if (postData && postData.id && postData.content) {
                            posts.push(postData);
                        }
                    });
                    renderPosts(filterAndSortPosts(posts));
                } catch (error) {
                    console.error('Error al ordenar publicaciones:', error);
                    errorDiv.textContent = 'Error al ordenar publicaciones. Intenta de nuevo.';
                }
            }).catch((error) => {
                console.error('Error al obtener publicaciones para ordenar:', error);
                errorDiv.textContent = 'Error al cargar publicaciones. Intenta de nuevo.';
            });
        });
    </script>
</body>
</html>
